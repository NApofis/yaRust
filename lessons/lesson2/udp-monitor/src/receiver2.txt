// Cargo.toml

[package]
name = "room_monitoring"
version = "0.1.0"
edition = "2021"

[features]
default = ["random"]  # –§–∏—á–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
random = ["dep:rand"] # –§–∏—á–∞ random –≤–∫–ª—é—á–∞–µ—Ç –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—É—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å rand
sqlite = []           # –ü—Ä–∏–º–µ—Ä –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π —Ñ–∏—á–∏
logging = ["dep:log"] # –ù–æ–≤–∞—è —Ñ–∏—á–∞ logging

[dependencies]
serde = { version = "1.0", features = ["derive"] }
bincode = "1.3"
rand = { version = "0.8", optional = true }  # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å
log = { version = "0.4", optional = true }   # –ù–æ–≤–∞—è –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å

[[bin]]
name = "sensor_simulator"
path = "src/bin/sensor_simulator.rs"

[[bin]]
name = "monitor"
path = "src/bin/monitor.rs"


// src/logging.rs

#[cfg(feature = "logging")]
pub use log::{debug, error, info, trace, warn};

// –ú–∞–∫—Ä–æ—Å—ã-–∑–∞–≥–ª—É—à–∫–∏, –∫–æ–≥–¥–∞ —Ñ–∏—á–∞ logging –æ—Ç–∫–ª—é—á–µ–Ω–∞
#[cfg(not(feature = "logging"))]
#[macro_export]
macro_rules! debug {
    ($($arg:tt)*) => {};
}

#[cfg(not(feature = "logging"))]
#[macro_export]
macro_rules! info {
    ($($arg:tt)*) => {};
}

#[cfg(not(feature = "logging"))]
#[macro_export]
macro_rules! warn {
    ($($arg:tt)*) => {};
}

#[cfg(not(feature = "logging"))]
#[macro_export]
macro_rules! error {
    ($($arg:tt)*) => {};
}

#[cfg(not(feature = "logging"))]
#[macro_export]
macro_rules! trace {
    ($($arg:tt)*) => {};
}

// –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
#[cfg(feature = "logging")]
pub fn init_logger() {
    env_logger::init();
    info!("–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ");
}

#[cfg(not(feature = "logging"))]
pub fn init_logger() {
    // –ù–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º, –∫–æ–≥–¥–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ
}

// src/lib.rs

pub mod metrics;
pub mod receiver;
pub mod sender;

// –£—Å–ª–æ–≤–Ω–æ –∫–æ–º–ø–∏–ª–∏—Ä—É–µ–º –º–æ–¥—É–ª—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
#[cfg(feature = "logging")]
pub mod logging;

#[cfg(not(feature = "logging"))]
mod logging;

pub use metrics::RoomMetrics;
pub use receiver::MetricsReceiver;
pub use sender::MetricsSender;

// –†–µ—ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –º–∞–∫—Ä–æ—Å—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
pub use logging::{debug, error, info, trace, warn, init_logger};

// src/sender.rs

use crate::{debug, error, info, warn, init_logger, RoomMetrics};
use bincode;
use std::net::UdpSocket;
use std::thread;
use std::time::Duration;

pub struct MetricsSender {
    socket: UdpSocket,
}

impl MetricsSender {
    pub fn new(bind_addr: &str) -> Result<Self, std::io::Error> {
        let socket = UdpSocket::bind(bind_addr)?;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, –µ—Å–ª–∏ —Ñ–∏—á–∞ –≤–∫–ª—é—á–µ–Ω–∞
        init_logger();

        info!("MetricsSender —Å–æ–∑–¥–∞–Ω –Ω–∞ –∞–¥—Ä–µ—Å–µ {}", bind_addr);
        Ok(Self { socket })
    }

    pub fn send_to(
        &self,
        metrics: &RoomMetrics,
        target_addr: &str,
    ) -> Result<(), Box<dyn std::error::Error>> {
        debug!("–°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–µ—Ç—Ä–∏–∫: {:?}", metrics);
        let encoded = bincode::serialize(metrics)?;

        debug!("–û—Ç–ø—Ä–∞–≤–∫–∞ {} –±–∞–π—Ç –Ω–∞ {}", encoded.len(), target_addr);
        let sent_bytes = self.socket.send_to(&encoded, target_addr)?;

        trace!("–£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ {} –±–∞–π—Ç", sent_bytes);
        Ok(())
    }

    pub fn start_broadcasting(
        self,
        target_addr: String,
        interval_ms: u64,
    ) -> Result<(), Box<dyn std::error::Error>> {
        info!(
            "–ó–∞–ø—É—Å–∫ —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏ –º–µ—Ç—Ä–∏–∫ –Ω–∞ {} –∫–∞–∂–¥—ã–µ {} –º—Å",
            target_addr, interval_ms
        );

        // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–∫–ª—é—á—ë–Ω–Ω—ã—Ö —Ñ–∏—á–∞—Ö
        #[cfg(feature = "random")]
        info!("–§–∏—á–∞ 'random' –∞–∫—Ç–∏–≤–Ω–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è rand –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö");

        #[cfg(not(feature = "random"))]
        warn!("–§–∏—á–∞ 'random' –æ—Ç–∫–ª—é—á–µ–Ω–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Å—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è");

        let mut counter = 0;

        loop {
            counter += 1;
            debug!("–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–µ—Ç—Ä–∏–∫ #{}", counter);

            let metrics = RoomMetrics::random();
            trace!("–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏: {:?}", metrics);

            match self.send_to(&metrics, &target_addr) {
                Ok(()) => {
                    info!(
                        "[{}] –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: {:.1}¬∞C, {:.1}% –≤–ª–∞–∂–Ω–æ—Å—Ç–∏, –¥–∞–≤–ª–µ–Ω–∏–µ: {:.1} hPa, –¥–≤–µ—Ä—å: {}",
                        metrics.formatted_time(),
                        metrics.temperature,
                        metrics.humidity,
                        metrics.pressure,
                        if metrics.door_open { "–æ—Ç–∫—Ä—ã—Ç–∞" } else { "–∑–∞–∫—Ä—ã—Ç–∞" },
                    );

                    // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–µ–≤–æ–∂–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π
                    if metrics.door_open {
                        warn!("üö® –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –æ—Ç–∫—Ä—ã—Ç–∞—è –¥–≤–µ—Ä—å!");
                    }
                    if metrics.temperature > 30.0 {
                        warn!("‚ö†Ô∏è  –í—ã—Å–æ–∫–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: {:.1}¬∞C", metrics.temperature);
                    }

                    // –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ñ–∏—á–∏ sqlite
                    #[cfg(feature = "sqlite")]
                    {
                        debug!("SQL-–∑–∞–ø—Ä–æ—Å: {}", metrics.to_sql());
                    }
                }
                Err(e) => {
                    error!("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –º–µ—Ç—Ä–∏–∫: {}", e);
                }
            }

            debug!("–û–∂–∏–¥–∞–Ω–∏–µ {} –º—Å –¥–æ —Å–ª–µ–¥—É—é—â–µ–π –æ—Ç–ø—Ä–∞–≤–∫–∏", interval_ms);
            thread::sleep(Duration::from_millis(interval_ms));
        }
    }
}

// src/receiver.rs

use crate::{debug, error, info, trace, warn, init_logger, RoomMetrics};
use bincode;
use std::net::UdpSocket;
use std::sync::mpsc;
use std::thread;

pub struct MetricsReceiver {
    socket: UdpSocket,
}

impl MetricsReceiver {
    pub fn new(bind_addr: &str) -> Result<Self, std::io::Error> {
        let socket = UdpSocket::bind(bind_addr)?;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, –µ—Å–ª–∏ —Ñ–∏—á–∞ –≤–∫–ª—é—á–µ–Ω–∞
        init_logger();

        info!("MetricsReceiver —Å–æ–∑–¥–∞–Ω –Ω–∞ –∞–¥—Ä–µ—Å–µ {}", bind_addr);
        Ok(Self { socket })
    }

    pub fn start_with_channel(
        self,
    ) -> (thread::JoinHandle<()>, mpsc::Receiver<(RoomMetrics, std::net::SocketAddr)>) {
        let (tx, rx) = mpsc::channel();

        info!("–ó–∞–ø—É—Å–∫ –ø—Ä–∏—ë–º–Ω–∏–∫–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ —Å –∫–∞–Ω–∞–ª–æ–º");

        let handle = thread::spawn(move || {
            if let Err(e) = self.receive_loop_with_channel(tx) {
                error!("–û—à–∏–±–∫–∞ –≤ receive_loop_with_channel: {}", e);
            }
        });

        (handle, rx)
    }

    fn receive_loop_with_channel(
        self,
        tx: mpsc::Sender<(RoomMetrics, std::net::SocketAddr)>,
    ) -> Result<(), Box<dyn std::error::Error>> {
        let mut buf = [0u8; 1024];
        let mut packet_count = 0;

        info!("–¶–∏–∫–ª –ø—Ä–∏—ë–º–∞ –¥–∞–Ω–Ω—ã—Ö –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω");

        loop {
            debug!("–û–∂–∏–¥–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...");
            match self.socket.recv_from(&mut buf) {
                Ok((size, src_addr)) => {
                    packet_count += 1;
                    trace!("–ü–æ–ª—É—á–µ–Ω–æ {} –±–∞–π—Ç –æ—Ç {}", size, src_addr);

                    match bincode::deserialize::<RoomMetrics>(&buf[..size]) {
                        Ok(metrics) => {
                            debug!("–£—Å–ø–µ—à–Ω–∞—è –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞–∫–µ—Ç–∞ #{}", packet_count);

                            // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∞–∂–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
                            if metrics.door_open {
                                warn!("üö® –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ —Å –æ—Ç–∫—Ä—ã—Ç–æ–π –¥–≤–µ—Ä—å—é –æ—Ç {}", src_addr);
                            }

                            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫
                            if tx.send((metrics, src_addr)).is_err() {
                                warn!("–ö–∞–Ω–∞–ª –∑–∞–∫—Ä—ã—Ç, –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø–æ—Ç–æ–∫–∞ –ø—Ä–∏—ë–º–∞");
                                break;
                            }

                            trace!("–ú–µ—Ç—Ä–∏–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ –∫–∞–Ω–∞–ª");
                        }
                        Err(e) => {
                            error!("–û—à–∏–±–∫–∞ –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–∞–∫–µ—Ç–∞ #{}: {}", packet_count, e);
                            debug!("–°—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ: {:?}", &buf[..size]);
                        }
                    }
                }
                Err(e) => {
                    error!("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö: {}", e);
                }
            }
        }

        info!("–¶–∏–∫–ª –ø—Ä–∏—ë–º–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞–≤–µ—Ä—à—ë–Ω. –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –ø–∞–∫–µ—Ç–æ–≤: {}", packet_count);
        Ok(())
    }
}


// examples/demo_all_features.rs

use room_monitoring::{init_logger, RoomMetrics, debug, info, warn};

fn main() {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, –µ—Å–ª–∏ —Ñ–∏—á–∞ –≤–∫–ª—é—á–µ–Ω–∞
    init_logger();

    println!("–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –≤—Å–µ—Ö features");
    println!("=============================");

    info!("–ù–∞—á–∞–ª–æ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —Ñ–∏—á");

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏
    debug!("–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –º–µ—Ç—Ä–∏–∫");
    let metrics = RoomMetrics::random();

    println!("–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏:");
    println!("  –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: {:.1}¬∞C", metrics.temperature);
    println!("  –í–ª–∞–∂–Ω–æ—Å—Ç—å: {:.1}%", metrics.humidity);
    println!("  –î–∞–≤–ª–µ–Ω–∏–µ: {:.1}hPa", metrics.pressure);
    println!("  –î–≤–µ—Ä—å: {}", if metrics.door_open { "–æ—Ç–∫—Ä—ã—Ç–∞" } else { "–∑–∞–∫—Ä—ã—Ç–∞" });

    // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è
    if metrics.door_open {
        warn!("–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –æ—Ç–∫—Ä—ã—Ç–∞—è –¥–≤–µ—Ä—å!");
    }
    if metrics.temperature > 25.0 {
        warn!("–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤—ã—à–µ –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ–π: {:.1}¬∞C", metrics.temperature);
    }

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º, –∫–∞–∫–∏–µ —Ñ–∏—á–∏ –∞–∫—Ç–∏–≤–Ω—ã
    info!("–ê–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏—á–∏:");

    #[cfg(feature = "random")]
    println!("–§–∏—á–∞ 'random' –∞–∫—Ç–∏–≤–Ω–∞");

    #[cfg(feature = "sqlite")]
    println!("–§–∏—á–∞ 'sqlite' –∞–∫—Ç–∏–≤–Ω–∞");

    #[cfg(feature = "logging")]
    println!("–§–∏—á–∞ 'logging' –∞–∫—Ç–∏–≤–Ω–∞");

    #[cfg(not(feature = "random"))]
    println!("–§–∏—á–∞ 'random' –æ—Ç–∫–ª—é—á–µ–Ω–∞");

    #[cfg(not(feature = "sqlite"))]
    println!("–§–∏—á–∞ 'sqlite' –æ—Ç–∫–ª—é—á–µ–Ω–∞");

    #[cfg(not(feature = "logging"))]
    println!("–§–∏—á–∞ 'logging' –æ—Ç–∫–ª—é—á–µ–Ω–∞");

    // –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ñ–∏—á–∏ sqlite
    #[cfg(feature = "sqlite")]
    {
        debug!("–ì–µ–Ω–µ—Ä–∞—Ü–∏—è SQL-–∑–∞–ø—Ä–æ—Å–∞");
        println!("\n SQL-–∑–∞–ø—Ä–æ—Å:");
        println!("{}", metrics.to_sql());
    }

    info!("–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞");
}

# –í —Ä–∞–∑–¥–µ–ª dependencies –¥–æ–±–∞–≤–ª—è–µ–º:
[dependencies]
# ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

# env_logger, —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –≤–∫–ª—é—á–µ–Ω–∞ —Ñ–∏—á–∞ logging
env_logger = { version = "0.10", optional = true }

# –ò –æ–±–Ω–æ–≤–ª—è–µ–º —Ñ–∏—á—É logging:
[features]
logging = ["dep:log", "dep:env_logger"]



# –í–∫–ª—é—á–∞–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —É—Ä–æ–≤–µ–Ω—å
RUST_LOG=info cargo run --example demo_all_features --features logging

# –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
RUST_LOG=debug cargo run --example demo_all_features --features logging

# –¢–æ–ª—å–∫–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –∏ –æ—à–∏–±–∫–∏
RUST_LOG=warn cargo run --example demo_all_features --features logging